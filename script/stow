#!/usr/bin/env bash
# Call stow with correct paths for dotfiles
#
# Should be able to run with `-R` to delete stale files, otherwise can do
# `find -L ~/.config -type l [-delete]` to find/remove stale links
#
# Usage: stow [-nv]

set -euo pipefail
IFS=$'\n\t'

main() {
  local dotfiles_root
  dotfiles_root="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
  local stowed_files_path="${dotfiles_root}/stowed-files"
  local target_dir="${HOME}"

  if ! command -v stow >/dev/null 2>&1; then
    >&2 echo "Error: stow command not found. Please install GNU Stow first."
    return 1
  fi

  if [[ ! -d "${stowed_files_path}" ]]; then
    >&2 echo "Warning: stowed-files directory not found at ${stowed_files_path}, skipping stow"
    return 0
  fi

  local packages=()
  local package_path
  for package_path in "${stowed_files_path}"/*; do
    [[ -d "${package_path}" ]] || continue
    packages+=("$(basename "${package_path}")")
  done

  if [[ ${#packages[@]} -eq 0 ]]; then
    >&2 echo "Warning: no packages found in ${stowed_files_path}, nothing to stow"
    return 0
  fi

  stow --dir="${stowed_files_path}/" --target="${target_dir}" \
    "${packages[@]}" "$@"
}

main "${@}"
