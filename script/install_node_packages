#!/usr/bin/env bash
# Set node to LTS and install global packages
#
# Usage: install_node_packages

set -euo pipefail
IFS=$'\n\t'

PACKAGES=(
  @anthropic-ai/claude-code
  @beads/bd
  @github/copilot
  @google/gemini-cli
  @google/jules
  @openai/codex
  bash-language-server
  cssmodules-language-server
  dockerfile-language-server-nodejs
  eslint
  fkill-cli
  neovim
  npm
  npm-check-updates
  prettier
  rome
  tsx
  typescript
  typescript-language-server
  vim-language-server
  vscode-langservers-extracted
  yaml-language-server
)

# shellcheck source=script/lib.sh
. "$(dirname "${BASH_SOURCE[0]}")/lib.sh"

install_node_packages() {
  if ! command_exists fnm; then
    >&2 echo "⨯ fnm not installed"
    exit 1
  fi

  echo "Installing node LTS …"

  # Use --arch arm64 when running on aarch64, otherwise fnm doesn't
  # auto-detect (happens on Docker on MacOS)
  if [[ "$(uname -m)" == "aarch64" ]]; then
    fnm install --lts --arch arm64
  else
    fnm install --lts
  fi

  echo "Setting node version to LTS …"
  fnm default lts-latest

  # Make sure to pick up necessary env vars
  eval "$(fnm env)"

  if [[ -f "$HOME/.profile" ]]; then
    # Load up PNPM_HOME and add to path
    # shellcheck source=/dev/null
    . "$HOME/.profile"
  else
    # `.profile` might not be created yet within the docker build process
    export PNPM_HOME="$HOME/.local/share/pnpm"
    export PATH="$PNPM_HOME:$PATH"
  fi

  # Make sure pnpm is setup (corepack is added by fnm when installing node)
  corepack enable

  # Corepack may need to download pnpm the first time
  corepack prepare pnpm@latest --activate

  echo "Installing global node packages …"
  pnpm add --global "${PACKAGES[@]}"
  echo "Node packages installed!"
}

if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
  install_node_packages "${@}"
fi
