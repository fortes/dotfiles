#!/usr/bin/env bash
# Set node to LTS and install global packages
#
# Usage: install_node_packages

set -euo pipefail
IFS=$'\n\t'

PACKAGES=(
  @anthropic-ai/claude-code
  @github/copilot
  @google/gemini-cli
  @google/jules
  @openai/codex
  bash-language-server
  cssmodules-language-server
  dockerfile-language-server-nodejs
  eslint
  fkill-cli
  neovim
  npm
  npm-check-updates
  prettier
  rome
  tsx
  typescript
  typescript-language-server
  vim-language-server
  vscode-langservers-extracted
  yaml-language-server
)

# shellcheck source=script/lib.sh
. "$(dirname "${BASH_SOURCE[0]}")/lib.sh"

install_node_packages() {
  if ! command_exists fnm; then
    >&2 echo "⨯ fnm not installed"
    exit 1
  fi

  # Check if node LTS is already installed
  if fnm list | grep -qE "\(lts/|lts-latest"; then
    echo "Node LTS already installed, skipping"
  else
    echo "Installing node LTS …"

    # Use --arch arm64 when running on aarch64, otherwise fnm doesn't
    # auto-detect (happens on Docker on MacOS)
    if [[ "$(uname -m)" == "aarch64" ]]; then
      fnm install --lts --arch arm64
    else
      fnm install --lts
    fi

    echo "Setting node version to LTS …"
    fnm default lts-latest
  fi

  # Make sure to pick up necessary env vars
  eval "$(fnm env)"

  if [[ -f "$HOME/.profile" ]]; then
    # Load up PNPM_HOME and add to path
    # shellcheck source=/dev/null
    . "$HOME/.profile"
  else
    # `.profile` might not be created yet within the docker build process
    export PNPM_HOME="$HOME/.local/share/pnpm"
    export PATH="$PNPM_HOME:$PATH"
  fi

  # Make sure pnpm is setup (corepack is added by fnm when installing node)
  corepack enable

  # Corepack may need to download pnpm the first time
  corepack prepare pnpm@latest --activate

  # Check if packages are already installed
  local missing_packages=()
  # Get a flat list of globally installed packages once to be efficient
  # Redirect stderr to avoid errors if no packages are installed, and use `|| true` to prevent script exit
  local installed_list
  installed_list="$(pnpm list --global --depth=0 2>/dev/null || true)"

  for package in "${PACKAGES[@]}"; do
    # Extract package name, removing only the version specifier (keep scope)
    local package_name_no_version="${package%%@*}"

    # Check for an exact match at the beginning of a line, followed by a space
    if ! echo "${installed_list}" | grep -q -E "^${package_name_no_version} "; then
      missing_packages+=("${package}")
    fi
  done

  if [[ ${#missing_packages[@]} -gt 0 ]]; then
    echo "Installing missing global node packages …"
    pnpm add --global "${missing_packages[@]}"
  else
    echo "All node packages already installed, skipping"
  fi
  echo "Node packages installed!"
}

if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
  install_node_packages "${@}"
fi
