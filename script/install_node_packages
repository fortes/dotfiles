#!/usr/bin/env bash
# Set node to LTS and install global packages
#
# Usage: install_node_packages

set -euo pipefail
IFS=$'\n\t'

PACKAGES=(
  @github/copilot
  @google/gemini-cli
  @google/jules
  @openai/codex
  @playwright/mcp@latest
  @typescript/native-preview
  bash-language-server
  cssmodules-language-server
  dockerfile-language-server-nodejs
  eslint
  fkill-cli
  neovim
  npm
  npm-check-updates
  opencode-ai
  prettier
  rome
  tsx
  typescript
  typescript-language-server
  vim-language-server
  vscode-langservers-extracted
  yaml-language-server
)

BUN_PACKAGES=(
  tobi/qmd
)

# shellcheck source=script/lib.sh
. "$(dirname "${BASH_SOURCE[0]}")/lib.sh"

print_usage() {
  cat <<EOF
Usage: $(basename "$0") [OPTIONS]

Set node to LTS and install global packages

Options:
  -p, --packages-only   Only install packages, skip Node.js installation
                        (useful for updating packages without changing Node version)
  -h, --help           Show this help message
EOF
}

install_node_packages() {
  # Parse arguments
  local packages_only=0

  while [[ "$#" -gt 0 ]]; do
    case "${1}" in
      -p | --packages-only)
        packages_only=1
        shift
        ;;
      -h | --help)
        print_usage
        exit 0
        ;;
      *)
        >&2 echo "Unknown option: ${1}"
        print_usage
        exit 1
        ;;
    esac
  done

  if ! command_exists fnm; then
    >&2 echo "⨯ fnm not installed"
    exit 1
  fi

  if [[ "${packages_only}" -eq 0 ]]; then
    echo "Installing node LTS …"

    # Use --arch arm64 when running on aarch64, otherwise fnm doesn't
    # auto-detect (happens on Docker on MacOS)
    if [[ "$(uname -m)" == "aarch64" ]]; then
      fnm install --lts --arch "arm64"
    else
      fnm install --lts
    fi

    echo "Setting node version to LTS …"
    fnm default "lts-latest"
  else
    echo "Only installing packages (--packages-only flag provided)"
  fi

  # Make sure to pick up necessary env vars
  eval "$(fnm env)"

  # Validate that node is available when using packages-only mode
  if [[ "${packages_only}" -eq 1 ]]; then
    if ! command_exists node; then
      >&2 echo "⨯ Node.js not found"
      >&2 echo "Either install Node.js first or run without --packages-only flag"
      exit 1
    fi

    if ! command_exists corepack; then
      >&2 echo "⨯ corepack not found (should be included with Node.js)"
      exit 1
    fi

    # Show current Node version
    echo "Using Node $(node --version)"
  fi

  if [[ -f "$HOME/.profile" ]]; then
    # Load up PNPM_HOME and add to path
    # shellcheck source=/dev/null
    . "$HOME/.profile"
  else
    # `.profile` might not be created yet within the docker build process
    export PNPM_HOME="$HOME/.local/share/pnpm"
    export PATH="$PNPM_HOME:$PATH"
  fi

  # Make sure pnpm is setup (corepack is added by fnm when installing node)
  corepack enable

  # Corepack may need to download pnpm the first time
  corepack prepare pnpm@latest --activate

  echo "Installing global node packages …"
  pnpm add --global "${PACKAGES[@]}"
  echo "Node packages installed!"

  # Install bun packages if bun is available
  if command_exists bun; then
    echo "Installing global bun packages …"
    # BUN_INSTALL is set in .profile to install to ~/.local/bin
    bun install --global "${BUN_PACKAGES[@]}"
    echo "Bun packages installed!"
  else
    echo "⚠ bun not found, skipping bun packages"
  fi
}

if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
  install_node_packages "${@}"
fi
