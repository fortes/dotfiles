#!/usr/bin/env bash
# Install some specific packages directly from GitHub. Specifically:
#
# - Duf
# - Hugo
# - Neovim (latest)
# - Sad
#
# Usage `install_github_packages`

set -euo pipefail
IFS=$'\n\t'
export DEBIAN_FRONTEND=noninteractive

echo_stderr() {
  >&2 echo "${@}"
}

get_latest_release_url() {
  local repo="$1"
  local match="$2"

  local release_json_url="https://api.github.com/repos/${repo}/releases/latest"
  curl --silent "${release_json_url}" | jq -r '.assets[].browser_download_url' | grep "${match}"
}

install_duf() {
  local url="$(get_latest_release_url 'muesli/duf' 'linux_amd64.deb')"
  if [[ -z "${url}" ]]; then
    echo_stderr "Could not find url"
    exit 2
  fi
  pushd /tmp > /dev/null
  wget -O duf.deb "${url}"
  echo "Installing duf (requires sudo)"
  sudo dpkg -i duf.deb
  rm duf.deb
  popd > /dev/null
}

install_hugo() {
  local url="$(get_latest_release_url 'gohugoio/hugo' 'hugo_extended.*Linux-64bit\.deb')"
  if [[ -z "${url}" ]]; then
    echo_stderr "Could not find url"
    exit 2
  fi
  pushd /tmp > /dev/null
  wget --quiet -O hugo.deb "${url}"
  echo "Installing hugo (requires sudo)"
  sudo dpkg -i hugo.deb
  rm hugo.deb
  echo "Generating bash completion"
  hugo gen autocomplete --completionfile="$HOME/.local/completion.d/hugo_completion"
  popd > /dev/null
}

install_sad() {
  local url="$(get_latest_release_url 'ms-jpq/sad' 'x86_64-unknown-linux-gnu.deb')"
  if [[ -z "${url}" ]]; then
    echo_stderr "Could not find url"
    exit 2
  fi
  pushd /tmp > /dev/null
  wget -O sad.deb "${url}"
  echo "Installing sad (requires sudo)"
  sudo dpkg -i sad.deb
  rm sad.deb
  popd > /dev/null
}

install_neovim_stable() {
  echo "Installing neovim stable"
  wget "https://github.com/neovim/neovim/releases/download/stable/nvim.appimage" \
    --quiet --output-document "$HOME/.local/bin/nvim"
  chmod +x "$HOME/.local/bin/nvim"

  if [[ -n "${IS_DOCKER:-}" ]]; then
    echo "Expanding neovim AppImage"
    mkdir -p "$HOME/.local/appimages/nvim"
    (
      cd "$HOME/.local/appimages/nvim"
      mv "$HOME/.local/bin/nvim" .
      "$HOME/.local/appimages/nvim/nvim" --appimage-extract > /dev/null
      ln -s "$HOME/.local/appimages/nvim/squashfs-root/AppRun" "$HOME/.local/bin/nvim"
    )
  fi
}

main() {
  . "$HOME/.profile.local"

  install_duf
  install_hugo
  install_neovim_stable
  install_sad
}

main
