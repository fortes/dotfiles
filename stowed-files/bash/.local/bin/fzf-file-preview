#!/usr/bin/env bash
# Used to preview files in fzf when using Ctrl-T
#
# Usage: fzf-directory-preview [dir]
set -euo pipefail

function fzf-file-preview() {
  local file="${1:-.}"

  # Use pistol if available
  if command -v pistol &>/dev/null; then
    exec pistol "${file}"
  fi

  if file "${file}" | grep -i "image" >/dev/null; then
    if command -v chafa &>/dev/null; then
      local term_width
      local term_height

      term_width=$(tput cols)
      term_height=$(tput lines)

      exec chafa --size "${term_width}x${term_height}" --format symbols "${file}" 2>&1
    fi
  fi

  local bat_name="bat"

  # For Debian-based systems that use `batcat`
  if command -v batcat &>/dev/null; then
    bat_name="batcat"
  fi

  if ! type "${bat_name}" &>/dev/null; then
    exec cat "${file}"
  fi

  exec "${bat_name}" "${file}" \
    --color always
}

if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
  fzf-file-preview "$@"
fi

