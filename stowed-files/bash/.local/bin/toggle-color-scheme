#!/usr/bin/env bash
# Swap color scheme between light and dark in `tmux`
#
# Usage: toggle-color-scheme [light|dark]
set -euo pipefail

declare dir_path
dir_path="$(dirname "${BASH_SOURCE[0]}")"

main() {
  local new_theme
  new_theme="${1:-}"

  if [[ -z "${new_theme}" ]]; then
    local current_theme
    current_theme="$(get_current_color_theme)"

    if [[ "${current_theme}" == "light" ]]; then
      new_theme="dark"
    else
      new_theme="light"
    fi
  elif  [[ "${new_theme}" != "light" && "${new_theme}" != "dark" ]]; then
    echo "Error: Invalid theme. Use 'light' or 'dark'." >&2
    exit 1
  fi

  echo -n "Setting color scheme to ${new_theme}..."

  # Colorscheme scripts have unbound variables
  set +u
  if [[ "${new_theme}" == "light" ]]; then
    # shellcheck source=../../../../script/base16-default-light.sh
    . ~/dotfiles/script/base16-default-light.sh
  else
    # shellcheck source=../../../../script/base16-default-dark.sh
    . ~/dotfiles/script/base16-default-dark.sh
  fi
  set -u

  update_tmux_colors "${new_theme}"
  update_cmus_colors "${new_theme}"
  update_neovim_colors "${new_theme}"

  echo "done!"
}

get_current_color_theme() {
  if tmux has-session > /dev/null 2>&1; then
    local tmux_value
    tmux_value="$(tmux show-environment -g COLOR_THEME 2>/dev/null || true)"
    if [[ -n "${tmux_value}" ]]; then
      echo "${tmux_value}" | cut -d= -f2-
      return
    fi
  fi

  if [[ -n "${COLOR_THEME:-}" ]]; then
    echo "${COLOR_THEME}"
    return;
  fi

  # Get terminal background color and extract red channel
  red_bg_value=$("${dir_path}/get-terminal-background-color" | cut -d: -f2)

  # Look at the first digit of the red value, and assume anything more than
  # half is light, and anything less is dark
  if [[ "${red_bg_value:0:1}" =~ [8-9A-Fa-f] ]]; then
    echo "light"
  else
    echo "dark"
  fi
}

# Check if cmus is running and update its colors if so
update_cmus_colors() {
  local new_theme
  new_theme="${1:-}"

  if pgrep -x cmus > /dev/null; then
    if [[ "${new_theme}" == "light" ]]; then
      cmus-remote -C "colorscheme xterm-white"
    else
      cmus-remote -C "colorscheme spotify"
    fi
  fi
}

# Check if neovim is running and update its colors if so
update_neovim_colors() {
  local new_theme
  local neovim_socket_dir

  new_theme="${1:-}"
  neovim_socket_dir="$(dirname "$(nvim --headless -c 'echo v:servername' +qa 2>&1)")"

  if [[ "${neovim_socket_dir}" != "${XDG_RUNTIME_DIR:-}" ]]; then
    # Mac has a directory per process it seems
    neovim_socket_dir="$(dirname "${neovim_socket_dir}")"
  fi

  if [[ ! -d "${neovim_socket_dir}" ]]; then
    return
  fi

  # Change colorscheme of all neovim instances
  while IFS= read -r socket; do
    if [[ "${new_theme}" == "light" ]]; then
      nvim --server "${socket}" --remote-send "<Esc>:set background=light|colorscheme dayfox<cr>"
    else
      nvim --server "${socket}" --remote-send "<Esc>:set background=dark|colorscheme carbonfox<cr>"
    fi
  done < <(find "${neovim_socket_dir}" -type s -name "nvim*" 2>/dev/null)
}

update_tmux_colors() {
  local new_theme
  new_theme="${1:-}"

  # Check if tmux is running first
  if ! tmux has-session > /dev/null 2>&1; then
    return
  fi

  tmux set-environment -g COLOR_THEME "${new_theme}" && \
    tmux set-environment COLOR_THEME "${new_theme}" && \
    tmux source-file ~/.config/tmux/tmux.conf && \
    tmux refresh-client -S
}

if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
  main "${@:-}"
fi
