#!/usr/bin/env bash
#
# Display current track information if cmus is playing

set -euo pipefail
IFS=$'\n\t'

main() {
  if [[ ! -f /tmp/cmus-status.txt ]]; then
    return
  fi

  local status="$(sed -n 1p /tmp/cmus-status.txt)"
  if [[ "${status}" == "stopped" ]]; then
    return
  fi

  # Sanity check that cmus hasn't exited, since status might not update
  if ! cmus-remote -Q > /dev/null 2>&1; then
    rm -f /tmp/cmus-status.txt
    return
  fi

  if [[ "${status}" == "paused" ]]; then
    local album="$(sed -n 4p /tmp/cmus-status.txt)"
    local albumartist="$(sed -n 5p /tmp/cmus-status.txt)"
    echo "${albumartist} ♪ ${album}  "
  else
    local title="$(sed -n 2p /tmp/cmus-status.txt)"
    local artist="$(sed -n 3p /tmp/cmus-status.txt)"
    echo "${artist} ▸ ${title}  "
  fi
}

main "${@}"
