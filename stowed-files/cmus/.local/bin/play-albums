#!/usr/bin/env bash
[[ "$TRACE" ]] && set -xtrace

set -o errexit
set -o nounset
set -o pipefail

BEET_FORMAT_STRING='$mb_albumid $albumartist - [$original_year] $album'

main() {
  declare -r cmus_stats=$(cmus-remote -Q)
  declare -r album_ids=$(beet ls -f"$BEET_FORMAT_STRING" -a "$@" albumartist+ original_year+ | \
    fzf --multi -1 -0 --with-nth 2.. | awk '{print $1}')

  if [ -z "$album_ids" ]; then
    echo "No albums found"
    return 1
  fi

  declare query=""
  for album_id in $album_ids; do
    query="$query, mb_albumid:${album_id}"
  done

  # Remove initial ','
  query=$(echo "$query" | cut -c2-)

  echo "Playing $(wc -l <<< "$album_ids") albums"

  # Stop music first, then queue tracks, wait a beat to give to cmus before
  # unpausing to play
  cmus-remote -s && \
  beet play -y "$query" year- album- track+ && \
    sleep 1 && cmus-remote -n && cmus-remote -p
}

if cmus-remote -Q > /dev/null 2>&1; then
  if [[ -z "$@" ]]; then
    echo "You probably want an argument here"
    exit 1
  fi

  main "$@"
else
  echo "cmus not running"
  exit 1
fi
